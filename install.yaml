name: ddev-diffy

project_files:
  - docker-compose.diffy.yaml
  - commands/diffy/screenshot
  - config.diffy.yaml

ddev_version_constraint: '>= v1.24.10'

post_install_actions:
  - |
    #ddev-description:Download the latest version of the Diffy worker code
    # Backup existing .env one level up if it exists
    if [ -f diffy-worker/.env ]; then
      mv diffy-worker/.env diffy-worker.env.backup
    fi
    # Recreate directory
    rm -rf diffy-worker && mkdir diffy-worker
    docker run --rm \
      -v ./diffy-worker:/diffy-worker \
      --user $DDEV_UID:$DDEV_GID \
      ddev/ddev-utilities \
      bash -c "cd /diffy-worker && wget -qO- https://github.com/DiffyWebsite/diffy-worker/archive/refs/heads/main.tar.gz | tar xz --strip-components=1"
    # Restore .env if backup exists
    if [ -f diffy-worker.env.backup ]; then
      mv diffy-worker.env.backup diffy-worker/.env
    fi

removal_actions:
  - rm -rf diffy-worker
